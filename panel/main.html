<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>

<body>
  <h3>Specify Test Servers</h3>
    <table style="text-align: center; width: 100%">
      <tr><th>Server</th><th>Specify7 Build</th><th>Specify6 Build</th><th>Database</th></tr>
      %for server, info in state._asdict().items():
      <tr class="server">
        <td><a class="server-link" href="http://{{server + '.' + host}}/">{{server}}</a></td>
        <td><span class="sp7-build">?</span> - <a class="sp7-sha">?</a> - <span class="sp7-build-date">?</span></td>
        <td class="sp6-build"> </td>
        <td class="database"> </td>
      </tr>
      %end
    </table>
    <a href="/configure/">Change configuration.</a>
    <script>
      $.ajaxSetup({cache: false});

      function update() {
          $('tr.server').each(function() {
              var tr = this;
              var server = $('a.server-link', tr).attr('href')
              $.get(server + "static/build_version.txt")
                  .catch(function() { return "??"; })
                  .done(function(s) {
                      $('.sp7-build', tr).text(s);
                  });

              $.get(server + "static/git_sha.txt")
                  .done(function(s) {
                      $('.sp7-sha', tr)
                          .text(s.slice(0,8))
                          .attr('href', 'https://github.com/specify/specify7/commits/' + s);
                  })
                  .fail(function() {
                      $('.sp7-sha', tr).text("??").attr('href', 'https://github.com/specify/specify7');
                  });

              $.get(server + "static/build_date.txt")
                  .then(function(s) { return new Date(s).toLocaleString(); }, function() { return "??"; })
                  .done(function(s) { $('.sp7-build-date', tr).text(s); });

              $.get(server + "context/system_info.json")
                  .done(function(s) {
                      $('.sp6-build', tr).text(s.specify6_version);
                      $('.database', tr).text(s.database);
                  }).fail(function() {
                      $('.sp6-build', tr).text("??");
                      $('.database', tr).text("??");
                  });
          });
          setTimeout(update, 10*1000);
      }
      update();
    </script>
</body>
</html>

